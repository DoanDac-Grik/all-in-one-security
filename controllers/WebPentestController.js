const fs = require("fs");
// import xml2js Module
const { parseString } = require('xml2js');
class WebPentestController {
    //[GET] /
    showWebPentest(req, res, next) {
        res.render('Pentest/web-base', {
            'title': 'Scan url',
            'css': 'web'
        });
    }

    showResultReport(req, res, next) {
        res.render('ResultPentest/web', {
            'title': 'Scan web',
            'css': 'result-web'
        })
    }

    //[POST] /checkwebvulner
    checkVulner(req, res, next) {
        // using the readFileSync() function 
        // and passing the path to the file 
        const buffer = fs.readFileSync('public/file/scan2.xml');
        // use the toString() method to convert 
        // Buffer into String 
        const fileContent = buffer.toString();

        //xml data
        var xmldata = fileContent;
        const keys = ['name', 'riskcode', 'riskdesc', 'desc', 'solution', 'reference'];
        let reports = [];

        // parsing xml data
        parseString(xmldata, function (err, results) {
            // parsing to json
            let data = JSON.stringify(results);

            const reportAll = JSON.parse(data).OWASPZAPReport.site[0].alerts[0].alertitem ?? [];

            // Filter report
            reportAll.forEach((report, index) => {
                const obj = {};
                keys.forEach(key => {
                    obj[key] = report[key][0];
                    obj[key] = obj[key].replace(/["']/g, "`")
                });
                reports.push(obj);
            });
        });
        const url = req.body.url.trim();

        return res.render('ResultPentest/web', {
            'title': 'Scan web',
            'css': 'result-web',
            url,
            reports
        })
    }
}

module.exports = new WebPentestController();