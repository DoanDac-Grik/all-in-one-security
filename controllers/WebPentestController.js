const fs = require("fs");
var exec = require('child-process-promise').exec;
const { parseString } = require('xml2js');

class WebPentestController {
    //[GET] /
    showWebPentest(req, res, next) {
        res.render('Pentest/web-base', {
            'title': 'Scan url',
            'css': 'web'
        });
    }

    showResultReport(req, res, next) {
        res.render('ResultPentest/web', {
            'title': 'Scan web',
            'css': 'result-web'
        })
    }

    //[POST] /checkwebvulner
    checkVulner(req, res, next) {
        exec('/usr/share/zaproxy/zap.sh -cmd  -quickurl https://google.com -quickout /home/kali/Desktop/NewFolder/all-in-one-security/public/file/okzap.xml -quickprogress')
        .then(function (result) {
            const buffer = fs.readFileSync('public/file/okzap.xml');
            const fileContent = buffer.toString();
            var xmldata = fileContent;
            const keys = ['name', 'riskcode', 'riskdesc', 'desc', 'solution', 'reference'];
            let reports = [];

            parseString(xmldata, function (err, results) {
                // parsing to json
                let data = JSON.stringify(results);

                const reportAll = JSON.parse(data).OWASPZAPReport.site[0].alerts[0].alertitem ?? [];

                // Filter report
                reportAll.forEach((report, index) => {
                    const obj = {};
                    keys.forEach(key => {
                        obj[key] = report[key][0];
                        obj[key] = obj[key].replace(/["']/g, "`")
                    });
                    reports.push(obj);
                });
            });
            const url = req.body.url.trim();

            return res.render('ResultPentest/web', {
                'title': 'Scan web',
                'css': 'result-web',
                url,
                reports
            })
        })
        .catch(function (err) {
            console.error('ERROR: ', err);
        });
        
    }
}

module.exports = new WebPentestController();