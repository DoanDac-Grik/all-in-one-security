const checkSafeLink = require('../helpers/virusTotalCheckUrl');
class URLPentestController {
    //[GET]
    showWebURLPentest(req, res, next) {
        res.render('Pentest/web', {
            'title': 'Scan url',
            'css': 'web'
        });
        //trangchunhantienquocte24h.weebly.com
        //chongluadao.vn
    }
    //[POST] /checkSafeDomain
    checkSafeDomain(req, res, next){
        const domain = req.body.domain;
        //Ham filter string to Domain
        //
        console.log(domain)
        checkSafeLink.checkDomain(domain)
        .then(rawData1 => rawData1)
        .then(rawData2 => {
            rawData2 = JSON.parse(rawData2).data.attributes.last_analysis_results
            let trust=0; 
            let distrust=0;
            let unrated =0;
            let resultArr =[];      
            for (const [key, value] of Object.entries(rawData2)) {           
                if( value.result !== 'clean' && value.result !=='unrated'){
                    resultArr.push({[key]: value.result})
                    distrust++;
                }
                else if( value.result == 'unrated'){
                    unrated++;
                }
                else {
                    trust++;
                }
            }
            if(resultArr.length == 0){
                resultArr.push('No threat found!!!')
            }
            return {
                result: resultArr,
                trust: trust,
                distrust: distrust,
                unrated: unrated
            }
        })
        .then( data => res.send(data))
        .catch(err => console.error(err))
    }
    
}

module.exports = new URLPentestController();