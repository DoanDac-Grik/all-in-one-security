const checkSafeLink = require('../helpers/virusTotalHelper');
class URLPentestController {
    //[GET]
    showWebURLPentest(req, res, next) {
        res.render('Pentest/web', {
            'title': 'Scan domain',
            'css': 'web'
        });
    }

    // showResult(req, res, next) {
    //     res.render('ResultPentest/domain', {
    //         'title': 'Result for url',
    //         'css': 'result-domain'
    //     })
    // }
    
    //[POST] /checkSafeDomain
    checkSafeDomain(req, res, next) {
        let domain = req.body.domain;
        // Reduce URL
        domain = checkSafeLink.reduceUrl(domain);

        checkSafeLink.checkDomain(domain)
        .then(rawData1 => rawData1)
        .then(rawData2 => {
            rawData2 = JSON.parse(rawData2).data.attributes.last_analysis_results
            let trust=0; 
            let distrust=0;
            let unrated =0;
            let resultArr =[];      
            for (const [key, value] of Object.entries(rawData2)) {           
                if( value.result !== 'clean' && value.result !=='unrated'){
                    resultArr.push({[key]: value.result})
                    distrust++;
                }
                else if( value.result == 'unrated'){
                    unrated++;
                }
                else {
                    trust++;
                }
            }
            if(resultArr.length == 0){
                resultArr.push('No threat found!!!')
            }
            return {
                result: resultArr,
                trust: trust,
                distrust: distrust,
                unrated: unrated
            }
        })
        .then(data => res.render('ResultPentest/domain', {
            'title': 'Result for url',
            'css': 'result-domain',
            data,
            domain
        }))
        .catch(err => console.error(err))
    }

}

module.exports = new URLPentestController();